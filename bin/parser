#!/usr/bin/env python

import argparse
import os
import sys

if __name__ == "__main__":

    # get the pod parser direcory
    os.chdir('%s%c..' % (os.getcwd(), os.sep))
    podparser_dir = os.getcwd()

    # add parent directory of the podparser to the sys path
    os.chdir('%s%c..' % (podparser_dir, os.sep))
    sys.path.append(os.getcwd())

    # parse commandline arguments
    arg_parser = argparse.ArgumentParser(description='Tool for parsing postcode directories')

    arg_parser.add_argument('-c', '--commit',
                            action='store_true',
                            help='commit to database')
    arg_parser.add_argument('-C', '--config',
                            nargs=1,
                            help='configuration directory')
    arg_parser.add_argument('-d', '--directory',
                            nargs=1, 
                            help='postcode directory to be parsed')
    arg_parser.add_argument('-p', '--page',
                            help='single postcode directory page to be parsed')
    arg_parser.add_argument('-e', '--end',
                            default=9999,
                            type=int,
                            help='End page to be parsed (only applies to -d), If no end page given parse until last.')
    arg_parser.add_argument('-s', '--start',
                            default=0,
                            help='Start page to be parsed (only applies to -d). If no start page given start from 0.')
    arg_parser.add_argument('-v', '--verbose',
                            action='store_false',
                            help='print detailed output')
    arg_parser.add_argument('-w', '--williamson',
                            action='store_false',
                            help="parse williamson's directory")    
    args = arg_parser.parse_args()

    if args.config:
        if os.path.isdir(args.config[0]):
            config_dir = args.config
        else:
            print '*** Invalid config directory ***'
            print arg_parser.print_help()
            sys.exit(1)
    else:
        config_dir = '%s/etc' % podparser_dir 

    if args.directory:
        directory = args.directory[0]
    elif args.page:
        directory = args.page[0]
    else:
        print '*** No directory given ***'
        print arg_parser.print_help()
        sys.exit(1)

    # kick off parsing
    from podparser import parser
    parser.Parser(config_dir,
                  directory,
                  args.start,
                  args.end,
                  args.verbose,
                  args.williamson).run_parser()
    
    
